# Wonk Chatbot 云服务器部署指南

## 🖥️ 服务器信息
- **IP地址**: 120.55.160.247
- **系统**: 假设为 Ubuntu/Debian
- **状态**: 全新服务器，未配置

## 🚀 部署步骤

### 第一步：连接服务器
```bash
# 使用SSH连接服务器
ssh root@120.55.160.247
# 输入密码: @Whk35168
```

### 第二步：上传部署脚本
有两种方式上传文件到服务器：

#### 方式1：使用SCP上传（推荐）
在你的本地电脑上运行：
```bash
# 上传整个项目
scp -r "C:\Users\hongk\Desktop\Wonk (Wilboerht Chatbot)" root@120.55.160.247:/tmp/

# 或者只上传必要文件
scp -r deploy/ root@120.55.160.247:/tmp/
scp app.py requirements.txt root@120.55.160.247:/tmp/
scp -r templates/ static/ app/ root@120.55.160.247:/tmp/
```

#### 方式2：在服务器上直接下载
如果代码在GitHub上：
```bash
# 在服务器上执行
cd /tmp
git clone https://github.com/your-username/wonk-chatbot.git
```

### 第三步：执行部署脚本

#### 3.1 基础环境配置
```bash
# 进入部署目录
cd /tmp/deploy  # 或 /tmp/wonk-chatbot/deploy

# 给脚本执行权限
chmod +x *.sh

# 执行基础环境配置
./server_setup.sh
```

这个脚本会：
- ✅ 更新系统
- ✅ 安装Python、Nginx等必要软件
- ✅ 配置防火墙
- ✅ 创建应用用户
- ✅ 创建应用目录

#### 3.2 复制应用代码
```bash
# 复制应用代码到正确位置
cp -r /tmp/wonk-chatbot/* /opt/wonk-chatbot/
# 或者如果是分别上传的文件
cp /tmp/app.py /opt/wonk-chatbot/
cp /tmp/requirements.txt /opt/wonk-chatbot/
cp -r /tmp/templates /opt/wonk-chatbot/
cp -r /tmp/static /opt/wonk-chatbot/
cp -r /tmp/app /opt/wonk-chatbot/

# 设置正确的权限
chown -R wonk:wonk /opt/wonk-chatbot
```

#### 3.3 部署应用
```bash
# 执行应用部署脚本
./deploy_app.sh
```

这个脚本会：
- ✅ 创建Python虚拟环境
- ✅ 安装依赖包
- ✅ 创建systemd服务
- ✅ 启动应用
- ✅ 测试服务状态

#### 3.4 配置Nginx（可选但推荐）
```bash
# 执行Nginx配置脚本
./setup_nginx.sh
```

这个脚本会：
- ✅ 配置反向代理
- ✅ 设置安全头
- ✅ 优化静态文件服务
- ✅ 启动Nginx

### 第四步：测试访问

#### 4.1 直接访问Flask应用
```bash
# 测试Flask应用是否正常
curl http://localhost:5000
```

#### 4.2 公网访问测试
在浏览器中访问：
- **直接访问**: http://120.55.160.247:5000
- **通过Nginx**: http://120.55.160.247

## 🔧 服务管理命令

### 查看服务状态
```bash
systemctl status wonk-chatbot
```

### 启动/停止/重启服务
```bash
systemctl start wonk-chatbot
systemctl stop wonk-chatbot
systemctl restart wonk-chatbot
```

### 查看日志
```bash
# 查看实时日志
journalctl -u wonk-chatbot -f

# 查看最近的日志
journalctl -u wonk-chatbot -n 50
```

### 查看Nginx状态
```bash
systemctl status nginx
nginx -t  # 测试配置文件
```

## 🛠️ 故障排除

### 常见问题

#### 1. 服务启动失败
```bash
# 查看详细错误
journalctl -u wonk-chatbot -n 20

# 手动测试启动
cd /opt/wonk-chatbot
sudo -u wonk bash -c "source venv/bin/activate && python app.py"
```

#### 2. 端口被占用
```bash
# 查看端口占用
netstat -tlnp | grep :5000
lsof -i :5000

# 杀死占用进程
kill -9 <PID>
```

#### 3. 权限问题
```bash
# 重新设置权限
chown -R wonk:wonk /opt/wonk-chatbot
chmod +x /opt/wonk-chatbot/app.py
```

#### 4. 防火墙问题
```bash
# 检查防火墙状态
ufw status

# 开放端口
ufw allow 5000/tcp
ufw allow 80/tcp
```

## 🔒 安全建议

### 1. 修改默认密码
```bash
# 修改root密码
passwd root

# 创建新的管理员用户
adduser admin
usermod -aG sudo admin
```

### 2. 配置SSH密钥登录
```bash
# 生成SSH密钥对（在本地电脑）
ssh-keygen -t rsa -b 4096

# 上传公钥到服务器
ssh-copy-id root@120.55.160.247
```

### 3. 禁用密码登录（可选）
```bash
# 编辑SSH配置
nano /etc/ssh/sshd_config

# 修改以下配置
PasswordAuthentication no
PermitRootLogin prohibit-password

# 重启SSH服务
systemctl restart ssh
```

## 📊 监控和维护

### 1. 设置自动备份
```bash
# 创建备份脚本
cat > /opt/backup.sh << 'EOF'
#!/bin/bash
DATE=$(date +%Y%m%d_%H%M%S)
cp /opt/wonk-chatbot/data/database.db /opt/backups/database_$DATE.db
find /opt/backups -name "database_*.db" -mtime +7 -delete
EOF

chmod +x /opt/backup.sh

# 添加到crontab（每天备份）
echo "0 2 * * * /opt/backup.sh" | crontab -
```

### 2. 系统监控
```bash
# 查看系统资源
htop
df -h  # 磁盘使用
free -h  # 内存使用
```

## 🎉 部署完成

部署成功后，你的聊天机器人将在以下地址可用：
- **主要访问地址**: http://120.55.160.247
- **备用地址**: http://120.55.160.247:5000

现在任何人都可以通过这个IP地址访问你的聊天机器人了！

## 📝 下一步建议

1. **域名绑定**：如果有域名，可以解析到这个IP
2. **SSL证书**：配置HTTPS加密访问
3. **CDN加速**：如果用户较多，可以考虑CDN
4. **监控告警**：设置服务异常时的通知
