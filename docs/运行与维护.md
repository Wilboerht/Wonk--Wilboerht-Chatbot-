# 运行与维护

本指南帮助你启动/重启服务、在线调参与日常维护。

## 一、启动与重启

- 启动（开发模式，自动重载）：
```
.venv\Scripts\python -m uvicorn app.main:app --host 127.0.0.1 --port 8000 --reload
```
- 启动（生产建议）：
```
.venv\Scripts\python -m uvicorn app.main:app --host 0.0.0.0 --port 8000 --workers 2
```
- 重启：
  - 直接 Ctrl+C 停止，再执行上述启动命令

## 二、健康检查与基本验证
- 健康检查：GET /health → 200
- 查询测试：POST /api/query（{"query":"你的问题","top_k":5}）

## 三、在线调参（无需重启）
- 查看参数：
```
curl http://127.0.0.1:8000/api/config
```
- 更新参数：
```
curl -X PUT http://127.0.0.1:8000/api/config \
  -H "Content-Type: application/json" \
  -d "{\"fuse_alpha\":0.7,\"high\":0.45,\"low\":0.25}"
```
- 这些参数也已写入 config.yaml，重启后仍生效。

## 四、数据管理
- 导入数据（脚本）：见《数据导入指南》
- 导入数据（API）：POST /api/ingest
- 重建全文索引：POST /api/rebuild_index

## 五、日志与排错
- 日志输出：控制台输出（loguru）
- 常见日志：
  - Semantic retriever ready (fastembed): ... → 语义检索已就绪
  - FTS5 virtual table ready → 全文索引可用
  - Built vector cache from DB: N items → 语义向量缓存已构建
- 端口被占用：修改命令中的 --port 端口号

## 六、安全与鉴权
### 6.1 管理员Token设置
- 设置环境变量：`WONK_ADMIN_TOKEN=your-secure-token`
- 或复制 `.env.example` 为 `.env` 并修改
- 生产环境请使用强密码（建议32位随机字符串）

### 6.2 受保护的接口
以下接口需要管理员Token：
- POST /api/ingest（数据导入）
- PUT /api/config（配置修改）
- POST /api/rebuild_index（重建索引）

### 6.3 使用方法
```bash
# 设置Token
curl -H "Authorization: Bearer your-token" \
  -X PUT http://127.0.0.1:8000/api/config \
  -H "Content-Type: application/json" \
  -d '{"fuse_alpha":0.7}'
```

### 6.4 其他安全建议
- 内网部署：默认 CORS 允许任意来源，若对外提供服务请收紧 allow_origins
- HTTPS：生产环境建议使用 HTTPS 和反向代理

## 七、FAQ
- Q: 改了 config.yaml 但接口没变？
  - A: /api/config 的修改会写回文件；若直接手动改文件，需重启进程或调用更新接口使缓存刷新
- Q: 模型下载很慢？
  - A: fastembed 首次会下载 ONNX 模型（约100MB量级），之后离线可用；可预下载放入缓存目录

---
有需要可以加一个 Windows 服务/守护进程脚本，或 Docker 化部署（后续可做）。
