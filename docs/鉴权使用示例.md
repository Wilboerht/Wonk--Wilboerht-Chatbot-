# 鉴权使用示例

## 设置管理员Token

### 方法1：环境变量（推荐）
```bash
# Windows
set WONK_ADMIN_TOKEN=your-secure-token-here

# Linux/Mac
export WONK_ADMIN_TOKEN=your-secure-token-here
```

### 方法2：.env 文件
```bash
# 复制示例文件
cp .env.example .env

# 编辑 .env 文件
WONK_ADMIN_TOKEN=your-secure-token-here
```

### 方法3：使用默认Token（仅开发环境）
如果未设置环境变量，系统会使用默认Token：`wonk-admin-2025`

## 受保护的接口

以下接口需要管理员Token：
- `GET /api/config` - 查看配置
- `PUT /api/config` - 修改配置  
- `POST /api/ingest` - 导入数据
- `POST /api/rebuild_index` - 重建索引

## 使用示例

### curl 命令
```bash
# 查看配置
curl -H "Authorization: Bearer wonk-admin-2025" \
  http://127.0.0.1:8000/api/config

# 修改配置
curl -H "Authorization: Bearer wonk-admin-2025" \
  -H "Content-Type: application/json" \
  -X PUT http://127.0.0.1:8000/api/config \
  -d '{"fuse_alpha":0.8,"high":0.5,"low":0.3}'

# 导入数据
curl -H "Authorization: Bearer wonk-admin-2025" \
  -H "Content-Type: application/json" \
  -X POST http://127.0.0.1:8000/api/ingest \
  -d '{"items":[{"question":"测试问题","answer":"测试答案"}],"rebuild_index":true}'
```

### Python httpx
```python
import httpx

headers = {"Authorization": "Bearer wonk-admin-2025"}
base_url = "http://127.0.0.1:8000"

# 查看配置
response = httpx.get(f"{base_url}/api/config", headers=headers)
print(response.json())

# 修改配置
response = httpx.put(
    f"{base_url}/api/config", 
    headers=headers,
    json={"fuse_alpha": 0.8}
)
print(response.json())

# 导入数据
response = httpx.post(
    f"{base_url}/api/ingest",
    headers=headers,
    json={
        "items": [{"question": "测试问题", "answer": "测试答案"}],
        "rebuild_index": True
    }
)
print(response.json())
```

### JavaScript fetch
```javascript
const token = 'wonk-admin-2025';
const baseUrl = 'http://127.0.0.1:8000';
const headers = {
    'Authorization': `Bearer ${token}`,
    'Content-Type': 'application/json'
};

// 查看配置
fetch(`${baseUrl}/api/config`, { headers })
    .then(r => r.json())
    .then(console.log);

// 修改配置
fetch(`${baseUrl}/api/config`, {
    method: 'PUT',
    headers,
    body: JSON.stringify({ fuse_alpha: 0.8 })
})
.then(r => r.json())
.then(console.log);
```

## 错误处理

### 401 Unauthorized
- 原因：Token错误或格式不正确
- 解决：检查Token是否正确，确保格式为 `Bearer <token>`

### 403 Forbidden  
- 原因：未提供Token
- 解决：在请求头中添加 `Authorization: Bearer <token>`

### 示例错误响应
```json
{
    "detail": "Invalid admin token"
}
```

## 安全建议

1. **生产环境**：使用强密码作为Token（建议32位随机字符串）
2. **Token保护**：不要在代码中硬编码Token，使用环境变量
3. **HTTPS**：生产环境务必使用HTTPS传输
4. **定期更换**：定期更换管理员Token
5. **访问控制**：仅在必要时暴露管理接口到公网

## 生成安全Token

### Python
```python
import secrets
token = secrets.token_urlsafe(32)
print(f"WONK_ADMIN_TOKEN={token}")
```

### PowerShell
```powershell
[System.Web.Security.Membership]::GeneratePassword(32, 8)
```

### 在线工具
- https://www.random.org/passwords/
- https://passwordsgenerator.net/
