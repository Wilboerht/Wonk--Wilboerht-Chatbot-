# 数据转换工具使用指南

本指南介绍如何使用 `scripts/convert_data.py` 工具将 CSV/Excel 文件转换为 JSONL 或直接导入数据库。

## 支持的文件格式

### CSV 文件 (.csv)
- 支持多种编码：UTF-8、GBK、GB2312、UTF-8-BOM
- 逗号分隔值格式

### Excel 文件 (.xlsx, .xls)
- 支持新旧版本的 Excel 格式
- 自动读取第一个工作表

## 数据列要求

### 必需列
- **question**: 问题内容（必填）
- **answer**: 答案内容（必填）

### 可选列
- **language**: 语言代码（zh/en/auto，默认：auto）
- **tags**: 标签，支持逗号或分号分隔（如：AI,技术 或 AI;技术）
- **source**: 数据来源标记（默认：imported）

## 使用方法

### 1. 预览数据
在转换前查看数据格式是否正确：
```bash
.venv\Scripts\python scripts\convert_data.py data\your_file.csv --preview
```

### 2. 转换为 JSONL 文件
```bash
.venv\Scripts\python scripts\convert_data.py data\your_file.csv -o output.jsonl
```

### 3. 直接导入数据库
```bash
.venv\Scripts\python scripts\convert_data.py data\your_file.xlsx
```

### 4. 高级选项
```bash
# 导入时不重建索引（提高速度）
.venv\Scripts\python scripts\convert_data.py data\your_file.csv --no-rebuild

# 详细输出模式
.venv\Scripts\python scripts\convert_data.py data\your_file.csv -v

# 组合使用
.venv\Scripts\python scripts\convert_data.py data\your_file.xlsx -v --no-rebuild
```

## 命令行参数

| 参数 | 说明 | 示例 |
|------|------|------|
| `input_file` | 输入文件路径（必需） | `data\sample.csv` |
| `-o, --output` | 输出JSONL文件路径 | `-o converted.jsonl` |
| `--preview` | 预览模式，只显示前5行 | `--preview` |
| `--no-rebuild` | 导入时不重建索引 | `--no-rebuild` |
| `-v, --verbose` | 详细输出模式 | `-v` |

## 示例数据格式

### CSV 示例
```csv
question,answer,language,tags,source
什么是人工智能？,人工智能是计算机科学的一个分支...,zh,AI;技术,sample
What is machine learning?,Machine learning is a subset of AI...,en,AI;ML;技术,sample
如何学习编程？,学习编程建议从基础语法开始...,zh,编程;学习,sample
```

### Excel 示例
| question | answer | language | tags | source |
|----------|--------|----------|------|--------|
| 什么是区块链？ | 区块链是一种分布式账本技术... | zh | 区块链,技术 | sample |
| What is DevOps? | DevOps is a set of practices... | en | DevOps,开发 | sample |

## 输出示例

### 预览模式输出
```
=== 预览前5行数据 ===

第 1 行:
  问题: 什么是人工智能？
  答案: 人工智能是计算机科学的一个分支...
  语言: zh
  标签: AI,技术
  来源: sample
```

### 转换成功输出
```
[INFO] 成功读取CSV文件 (编码: utf-8): 5 行
[INFO] 验证数据格式...
[INFO] 有效数据: 5 行
[INFO] 转换完成: 5 条记录写入 output.jsonl
```

### 导入成功输出
```
[INFO] 成功读取Excel文件: 5 行
[INFO] 验证数据格式...
[INFO] 有效数据: 5 行
[INFO] 成功导入 5 条记录到数据库
[INFO] 已重建全文索引
```

## 错误处理

### 常见错误及解决方案

1. **文件不存在**
   ```
   FileNotFoundError: 文件不存在: data\nonexistent.csv
   ```
   - 检查文件路径是否正确

2. **编码问题**
   ```
   ValueError: 无法读取CSV文件，请检查文件编码
   ```
   - 尝试将文件另存为UTF-8编码

3. **缺少必需列**
   ```
   缺少必需列: ['question']
   ```
   - 确保CSV/Excel包含question和answer列

4. **数据验证警告**
   ```
   移除了 2 行空数据
   ```
   - 这是正常的，空行会被自动跳过

## 最佳实践

### 数据准备
1. **问题格式化**: 确保问题清晰、完整
2. **答案完整性**: 答案应该能够独立理解
3. **标签使用**: 使用有意义的标签便于分类管理
4. **编码统一**: 建议使用UTF-8编码保存文件

### 性能优化
1. **大文件处理**: 超过1000条记录建议使用 `--no-rebuild` 选项
2. **批量导入**: 一次性导入所有数据，最后统一重建索引
3. **预览验证**: 大文件导入前先用 `--preview` 检查格式

### 数据管理
1. **备份原始数据**: 导入前备份原始CSV/Excel文件
2. **版本控制**: 使用source字段标记数据版本
3. **增量更新**: 新数据使用不同的source值便于追踪

## 故障排除

### 权限问题
如果遇到数据库写入权限问题：
1. 确保数据库文件所在目录有写入权限
2. 检查是否有其他进程占用数据库文件

### 内存问题
处理大文件时如果遇到内存不足：
1. 分批处理大文件
2. 关闭其他占用内存的程序

### 依赖问题
如果遇到模块导入错误：
```bash
# 安装缺失的依赖
.venv\Scripts\pip install pandas openpyxl
```

---

**相关文档：**
- 《数据导入指南》- 完整的数据导入流程
- 《鉴权使用示例》- API导入的Token设置
