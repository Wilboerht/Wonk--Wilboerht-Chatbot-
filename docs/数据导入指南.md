# 数据导入指南

本指南说明如何将你的问答数据导入到 Wonk 聊天机器人。支持 CSV、Excel、JSONL 格式，以及 API 方式导入。

## 一、支持的数据格式

### 1.1 CSV/Excel 格式（推荐）
支持 .csv、.xlsx、.xls 文件，包含以下列：

**必需列：**
- question: 问题（必填）
- answer: 答案（必填）

**可选列：**
  - language: 语言代码（可选，zh/en/auto）
  - tags: 标签数组（可选）
  - source: 来源标记（可选）

示例（data/my_faq.jsonl）：
{"question": "项目作者是谁", "answer": "王泓坤", "language": "zh", "tags": ["meta"], "source": "user"}
{"question": "What is Wonk?", "answer": "Wonk is a local FAQ chatbot.", "language": "en"}

注意：
- 文件应为 UTF-8 编码
- 一行一个 JSON 对象；不要放置逗号或包裹整个数组

## 二、通过脚本导入（离线、批量）

1) 启动或停止服务均可导入（建议停止查询压力较大的情况下导入）
2) 运行脚本：
```
.venv\Scripts\python scripts\import_data.py data\my_faq.jsonl
```
3) 输出说明：
- Imported X items and rebuilt FTS index; skipped Y bad lines
- 若有坏行（格式不正确或缺少字段），会被跳过并统计

## 三、通过 API 导入（在线、灵活）

- URL: POST /api/ingest
- Body：
```
{
  "items": [
    {"question": "项目作者是谁", "answer": "王泓坤", "language": "zh", "tags": ["meta"], "source": "user"}
  ],
  "rebuild_index": true
}
```
- 返回：{"inserted": 1}

提示：rebuild_index=true 会重建全文索引（FTS），并触发语义向量缓存的失效，下一次查询自动重建。

## 四、导入后如何验证

- 健康检查：GET /health → 200
- 查询测试：
```
POST /api/query
{
  "query": "项目作者是谁",
  "top_k": 5
}
```
- 应能返回你导入的答案，并显示 candidates 与 confidence 分值

## 五、常见问题排查

- FTS5 不可用 → 会自动回退到 LIKE 检索；可继续使用，但召回较弱
- 语义检索未生效 → 首次需要下载 fastembed 模型文件；网络可用时等待完成；下载后可离线
- 新数据未被语义检索命中 → 稍等或重新查询；系统会在下一次查询时自动重建语义缓存
- JSONL 文件含坏行 → 导入脚本会跳过坏行；可用在线校验工具检测每行 JSON 是否有效

## 六、安全建议

- 若服务暴露在外网：
  - 为 /api/ingest 与 /api/config 增加管理 Token 或仅限内网访问
  - 收紧 CORS 与请求来源

## 七、最佳实践

- 保持 question 为“标准问”，answer 为“你希望返回的标准答案”
- 对问法较多的问题，建议在 answer 中补充关键词，帮助 BM25 命中
- 中文为主时推荐 fastembed 模型 BAAI/bge-small-zh-v1.5（默认）
- 英文为主可设 WONK_FE_MODEL=BAAI/bge-small-en-v1.5 后重启

---
如需我为你批量转换 CSV/Excel 为 JSONL，请把文件发我或给出样例列名。
