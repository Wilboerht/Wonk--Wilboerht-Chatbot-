# Wonk Chatbot æœåŠ¡å™¨å®Œæ•´é…ç½®è®°å½•

## ðŸ“‹ æœåŠ¡å™¨ä¿¡æ¯
- **æœåŠ¡å™¨IP**: 120.55.160.247
- **ç³»ç»Ÿ**: Alibaba Cloud Linux 3.2104 U12 (OpenAnolis Edition)
- **æž¶æž„**: x86_64
- **Pythonç‰ˆæœ¬**: 3.6.8
- **éƒ¨ç½²æ—¶é—´**: 2025-08-09/10

## ðŸš€ å®Œæ•´éƒ¨ç½²æµç¨‹

### ç¬¬ä¸€æ­¥ï¼šè¿žæŽ¥æœåŠ¡å™¨
```bash
ssh root@120.55.160.247
# å¯†ç : @Whk35168
```

### ç¬¬äºŒæ­¥ï¼šä¸‹è½½é¡¹ç›®ä»£ç 
```bash
cd /tmp
yum install -y git
git clone https://github.com/Wilboerht/Wonk--Wilboerht-Chatbot-.git
```

### ç¬¬ä¸‰æ­¥ï¼šæœåŠ¡å™¨çŽ¯å¢ƒé…ç½®
```bash
cd /tmp/Wonk--Wilboerht-Chatbot-/deploy

# åˆ›å»ºé€‚é…é˜¿é‡Œäº‘Linuxçš„é…ç½®è„šæœ¬
cat > server_setup_alinux.sh << 'EOF'
#!/bin/bash
set -e

# é¢œè‰²å®šä¹‰
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

log_info() { echo -e "${GREEN}[INFO]${NC} $1"; }
log_warn() { echo -e "${YELLOW}[WARN]${NC} $1"; }
log_error() { echo -e "${RED}[ERROR]${NC} $1"; }

# æ›´æ–°ç³»ç»Ÿ
log_info "æ›´æ–°ç³»ç»ŸåŒ…..."
yum update -y

# å®‰è£…åŸºç¡€è½¯ä»¶
log_info "å®‰è£…åŸºç¡€è½¯ä»¶åŒ…..."
yum install -y python3 python3-pip git nginx firewalld curl wget unzip htop tree

# é…ç½®é˜²ç«å¢™
log_info "é…ç½®é˜²ç«å¢™..."
systemctl start firewalld
systemctl enable firewalld
firewall-cmd --permanent --add-service=ssh
firewall-cmd --permanent --add-service=http
firewall-cmd --permanent --add-service=https
firewall-cmd --permanent --add-port=5000/tcp
firewall-cmd --reload

# åˆ›å»ºåº”ç”¨ç”¨æˆ·
log_info "åˆ›å»ºåº”ç”¨ç”¨æˆ·..."
if id "wonk" &>/dev/null; then
    log_warn "ç”¨æˆ· wonk å·²å­˜åœ¨"
else
    useradd -m -s /bin/bash wonk
    log_info "ç”¨æˆ· wonk åˆ›å»ºå®Œæˆ"
fi

# åˆ›å»ºåº”ç”¨ç›®å½•
log_info "è®¾ç½®åº”ç”¨ç›®å½•..."
mkdir -p /opt/wonk-chatbot
chown wonk:wonk /opt/wonk-chatbot

log_info "æœåŠ¡å™¨åŸºç¡€çŽ¯å¢ƒé…ç½®å®Œæˆï¼"
EOF

chmod +x server_setup_alinux.sh
./server_setup_alinux.sh
```

### ç¬¬å››æ­¥ï¼šå¤åˆ¶é¡¹ç›®ä»£ç 
```bash
cp -r /tmp/Wonk--Wilboerht-Chatbot-/* /opt/wonk-chatbot/
chown -R wonk:wonk /opt/wonk-chatbot
```

### ç¬¬äº”æ­¥ï¼šåˆ›å»ºPython 3.6å…¼å®¹çš„ä¾èµ–æ–‡ä»¶
```bash
cd /opt/wonk-chatbot

cat > requirements_py36_compatible.txt << 'EOF'
# Flask Webæ¡†æž¶ - Python 3.6å…¼å®¹ç‰ˆæœ¬
Flask==2.0.3
Werkzeug==2.0.3
Jinja2==3.0.3
MarkupSafe==2.0.1
click==8.0.4
itsdangerous==2.0.1

# åŸºç¡€ä¾èµ–
python-dotenv==0.19.2
PyYAML==6.0
requests==2.27.1

# æ•°æ®å¤„ç† - ç®€åŒ–ç‰ˆæœ¬
pandas==1.1.5
openpyxl==3.0.10

# æ–‡æœ¬å¤„ç†
jieba==0.42.1

# æ—¥å¿—
loguru==0.5.3

# Pydantic - Python 3.6å…¼å®¹ç‰ˆæœ¬
pydantic==1.9.2
EOF
```

### ç¬¬å…­æ­¥ï¼šå®‰è£…Pythonä¾èµ–
```bash
# åˆ›å»ºè™šæ‹ŸçŽ¯å¢ƒ
sudo -u wonk python3 -m venv venv

# å®‰è£…ä¾èµ–ï¼ˆä½¿ç”¨å›½å†…é•œåƒæºï¼‰
sudo -u wonk bash -c "
    source venv/bin/activate
    pip install -i https://pypi.tuna.tsinghua.edu.cn/simple/ -r requirements_py36_compatible.txt --timeout=60 --retries=3
"
```

### ç¬¬ä¸ƒæ­¥ï¼šåˆ›å»ºsystemdæœåŠ¡
```bash
cat > /etc/systemd/system/wonk-chatbot.service << 'EOF'
[Unit]
Description=Wonk Chatbot
After=network.target

[Service]
Type=simple
User=wonk
WorkingDirectory=/opt/wonk-chatbot
Environment=PATH=/opt/wonk-chatbot/venv/bin
Environment=FLASK_ENV=production
Environment=PYTHONUNBUFFERED=1
ExecStart=/opt/wonk-chatbot/venv/bin/python app.py
Restart=always
RestartSec=3

[Install]
WantedBy=multi-user.target
EOF

systemctl daemon-reload
systemctl enable wonk-chatbot
systemctl start wonk-chatbot
```

### ç¬¬å…«æ­¥ï¼šé…ç½®Nginxåå‘ä»£ç†
```bash
cat > /etc/nginx/conf.d/wonk-chatbot.conf << 'EOF'
server {
    listen 80 default_server;
    server_name chatbot.wilboerht.cn 120.55.160.247 _;

    # å®‰å…¨å¤´
    add_header X-Frame-Options DENY;
    add_header X-Content-Type-Options nosniff;
    add_header X-XSS-Protection "1; mode=block";

    # é™æ€æ–‡ä»¶
    location /static/ {
        proxy_pass http://127.0.0.1:5000;
        expires 1y;
        add_header Cache-Control "public, immutable";
    }

    # ä¸»åº”ç”¨
    location / {
        proxy_pass http://127.0.0.1:5000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # è¶…æ—¶è®¾ç½®
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
    }
}
EOF

nginx -t
systemctl restart nginx
systemctl enable nginx
```

### ç¬¬ä¹æ­¥ï¼šé…ç½®SSLè¯ä¹¦
```bash
# å®‰è£…certbot
yum install -y certbot python3-certbot-nginx

# èŽ·å–SSLè¯ä¹¦
certbot --nginx -d chatbot.wilboerht.cn
# é‚®ç®±: wilboerht@163.com
# åŒæ„æ¡æ¬¾: Y
# åˆ†äº«é‚®ç®±: N

# è®¾ç½®è‡ªåŠ¨ç»­æœŸ
echo "0 12 * * * /usr/bin/certbot renew --quiet" | crontab -
```

## ðŸ”§ æœ€ç»ˆé…ç½®çŠ¶æ€

### æœåŠ¡çŠ¶æ€
```bash
# åº”ç”¨æœåŠ¡
systemctl status wonk-chatbot

# NginxæœåŠ¡
systemctl status nginx

# é˜²ç«å¢™çŠ¶æ€
firewall-cmd --list-all
```

### ç«¯å£ç›‘å¬
```bash
ss -tlnp | grep -E "(80|443|5000)"
```

### è®¿é—®åœ°å€
- **HTTPSï¼ˆæŽ¨èï¼‰**: https://chatbot.wilboerht.cn
- **HTTP**: http://chatbot.wilboerht.cn ï¼ˆè‡ªåŠ¨é‡å®šå‘åˆ°HTTPSï¼‰
- **IPè®¿é—®**: http://120.55.160.247
- **ç›´æŽ¥è®¿é—®**: http://120.55.160.247:5000

### é‡è¦æ–‡ä»¶ä½ç½®
- **åº”ç”¨ç›®å½•**: `/opt/wonk-chatbot/`
- **è™šæ‹ŸçŽ¯å¢ƒ**: `/opt/wonk-chatbot/venv/`
- **æ•°æ®åº“**: `/opt/wonk-chatbot/data/database.db`
- **systemdæœåŠ¡**: `/etc/systemd/system/wonk-chatbot.service`
- **Nginxé…ç½®**: `/etc/nginx/conf.d/wonk-chatbot.conf`
- **SSLè¯ä¹¦**: `/etc/letsencrypt/live/chatbot.wilboerht.cn/`

### æ—¥å¿—æŸ¥çœ‹
```bash
# åº”ç”¨æ—¥å¿—
journalctl -u wonk-chatbot -f

# Nginxè®¿é—®æ—¥å¿—
tail -f /var/log/nginx/access.log

# Nginxé”™è¯¯æ—¥å¿—
tail -f /var/log/nginx/error.log

# SSLè¯ä¹¦æ—¥å¿—
tail -f /var/log/letsencrypt/letsencrypt.log
```

## ðŸ› ï¸ ç»´æŠ¤å‘½ä»¤

### æœåŠ¡ç®¡ç†
```bash
# é‡å¯åº”ç”¨
systemctl restart wonk-chatbot

# é‡å¯Nginx
systemctl restart nginx

# æŸ¥çœ‹æœåŠ¡çŠ¶æ€
systemctl status wonk-chatbot nginx
```

### è¯ä¹¦ç®¡ç†
```bash
# æ‰‹åŠ¨ç»­æœŸè¯ä¹¦
certbot renew

# æŸ¥çœ‹è¯ä¹¦çŠ¶æ€
certbot certificates

# æŸ¥çœ‹è‡ªåŠ¨ç»­æœŸä»»åŠ¡
crontab -l
```

### å¤‡ä»½é‡è¦æ•°æ®
```bash
# å¤‡ä»½æ•°æ®åº“
cp /opt/wonk-chatbot/data/database.db /opt/wonk-chatbot/data/database_$(date +%Y%m%d_%H%M%S).db

# å¤‡ä»½é…ç½®æ–‡ä»¶
tar -czf /root/wonk-backup-$(date +%Y%m%d).tar.gz \
    /opt/wonk-chatbot/ \
    /etc/nginx/conf.d/wonk-chatbot.conf \
    /etc/systemd/system/wonk-chatbot.service
```

## âœ… éƒ¨ç½²éªŒè¯æ¸…å•

- [x] æœåŠ¡å™¨è¿žæŽ¥æ­£å¸¸
- [x] é¡¹ç›®ä»£ç ä¸‹è½½å®Œæˆ
- [x] ç³»ç»ŸçŽ¯å¢ƒé…ç½®å®Œæˆ
- [x] Pythonä¾èµ–å®‰è£…æˆåŠŸ
- [x] åº”ç”¨æœåŠ¡å¯åŠ¨æ­£å¸¸
- [x] Nginxåå‘ä»£ç†é…ç½®æˆåŠŸ
- [x] é˜²ç«å¢™ç«¯å£å¼€æ”¾æ­£ç¡®
- [x] SSLè¯ä¹¦é…ç½®æˆåŠŸ
- [x] HTTPSè®¿é—®æ­£å¸¸
- [x] HTTPè‡ªåŠ¨é‡å®šå‘
- [x] è¯ä¹¦è‡ªåŠ¨ç»­æœŸè®¾ç½®
- [x] åŸŸåè§£æžæ­£å¸¸

## ðŸ”’ å®‰å…¨é…ç½®

### é˜²ç«å¢™è§„åˆ™
```bash
# å½“å‰å¼€æ”¾ç«¯å£
firewall-cmd --list-ports
# è¾“å‡º: 5000/tcp

# å½“å‰å¼€æ”¾æœåŠ¡
firewall-cmd --list-services
# è¾“å‡º: cockpit dhcpv6-client http https ssh
```

### SSLè¯ä¹¦è¯¦æƒ…
```bash
# è¯ä¹¦æ–‡ä»¶ä½ç½®
/etc/letsencrypt/live/chatbot.wilboerht.cn/fullchain.pem  # è¯ä¹¦é“¾
/etc/letsencrypt/live/chatbot.wilboerht.cn/privkey.pem    # ç§é’¥

# è¯ä¹¦æœ‰æ•ˆæœŸ
# é¢å‘æ—¶é—´: 2025-08-10
# åˆ°æœŸæ—¶é—´: 2025-11-08
# è‡ªåŠ¨ç»­æœŸ: æ¯å¤©12:00æ£€æŸ¥
```

### Nginxæœ€ç»ˆé…ç½®
```nginx
# /etc/nginx/conf.d/wonk-chatbot.conf
server {
    server_name chatbot.wilboerht.cn 120.55.160.247 _;

    # å®‰å…¨å¤´
    add_header X-Frame-Options DENY;
    add_header X-Content-Type-Options nosniff;
    add_header X-XSS-Protection "1; mode=block";

    # é™æ€æ–‡ä»¶ç¼“å­˜
    location /static/ {
        proxy_pass http://127.0.0.1:5000;
        expires 1y;
        add_header Cache-Control "public, immutable";
    }

    # ä¸»åº”ç”¨ä»£ç†
    location / {
        proxy_pass http://127.0.0.1:5000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
    }

    # SSLé…ç½® (ç”±certbotè‡ªåŠ¨æ·»åŠ )
    listen 443 ssl;
    ssl_certificate /etc/letsencrypt/live/chatbot.wilboerht.cn/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/chatbot.wilboerht.cn/privkey.pem;
    include /etc/letsencrypt/options-ssl-nginx.conf;
    ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem;
}

# HTTPé‡å®šå‘åˆ°HTTPS
server {
    if ($host = chatbot.wilboerht.cn) {
        return 301 https://$host$request_uri;
    }

    listen 80 default_server;
    server_name chatbot.wilboerht.cn 120.55.160.247 _;
    return 404;
}
```

## ðŸ“Š æ€§èƒ½ç›‘æŽ§

### ç³»ç»Ÿèµ„æºä½¿ç”¨
```bash
# å†…å­˜ä½¿ç”¨
free -h

# ç£ç›˜ä½¿ç”¨
df -h

# CPUä½¿ç”¨
htop

# è¿›ç¨‹ç›‘æŽ§
ps aux | grep -E "(python|nginx)"
```

### åº”ç”¨ç›‘æŽ§
```bash
# åº”ç”¨è¿›ç¨‹çŠ¶æ€
systemctl status wonk-chatbot

# å®žæ—¶æ—¥å¿—
journalctl -u wonk-chatbot -f

# è®¿é—®ç»Ÿè®¡
tail -f /var/log/nginx/access.log | grep -E "(GET|POST)"
```

## ðŸš¨ æ•…éšœæŽ’é™¤

### å¸¸è§é—®é¢˜åŠè§£å†³æ–¹æ¡ˆ

#### 1. åº”ç”¨æ— æ³•å¯åŠ¨
```bash
# æŸ¥çœ‹è¯¦ç»†é”™è¯¯
journalctl -u wonk-chatbot -n 50

# æ‰‹åŠ¨æµ‹è¯•å¯åŠ¨
sudo -u wonk bash -c "cd /opt/wonk-chatbot && source venv/bin/activate && python app.py"

# æ£€æŸ¥ä¾èµ–
sudo -u wonk bash -c "cd /opt/wonk-chatbot && source venv/bin/activate && pip list"
```

#### 2. SSLè¯ä¹¦é—®é¢˜
```bash
# æ£€æŸ¥è¯ä¹¦çŠ¶æ€
certbot certificates

# æ‰‹åŠ¨ç»­æœŸ
certbot renew --dry-run

# é‡æ–°èŽ·å–è¯ä¹¦
certbot --nginx -d chatbot.wilboerht.cn --force-renewal
```

#### 3. åŸŸåè§£æžé—®é¢˜
```bash
# æ£€æŸ¥DNSè§£æž
nslookup chatbot.wilboerht.cn
dig chatbot.wilboerht.cn

# æµ‹è¯•è¿žé€šæ€§
ping chatbot.wilboerht.cn
```

#### 4. ç«¯å£è®¿é—®é—®é¢˜
```bash
# æ£€æŸ¥ç«¯å£ç›‘å¬
netstat -tlnp | grep -E "(80|443|5000)"
ss -tlnp | grep -E "(80|443|5000)"

# æ£€æŸ¥é˜²ç«å¢™
firewall-cmd --list-all
```

## ðŸ”„ æ›´æ–°éƒ¨ç½²

### æ›´æ–°åº”ç”¨ä»£ç 
```bash
# å¤‡ä»½å½“å‰ç‰ˆæœ¬
cp -r /opt/wonk-chatbot /opt/wonk-chatbot-backup-$(date +%Y%m%d)

# æ‹‰å–æœ€æ–°ä»£ç 
cd /tmp
rm -rf Wonk--Wilboerht-Chatbot-
git clone https://github.com/Wilboerht/Wonk--Wilboerht-Chatbot-.git

# æ›´æ–°åº”ç”¨æ–‡ä»¶
cp -r /tmp/Wonk--Wilboerht-Chatbot-/* /opt/wonk-chatbot/
chown -R wonk:wonk /opt/wonk-chatbot

# é‡å¯æœåŠ¡
systemctl restart wonk-chatbot
```

### æ›´æ–°Pythonä¾èµ–
```bash
cd /opt/wonk-chatbot
sudo -u wonk bash -c "
    source venv/bin/activate
    pip install -r requirements_py36_compatible.txt --upgrade
"
systemctl restart wonk-chatbot
```

## ðŸŽ‰ éƒ¨ç½²æˆåŠŸï¼

ä½ çš„WonkèŠå¤©æœºå™¨äººçŽ°å·²æˆåŠŸéƒ¨ç½²å¹¶å¯¹å…¨ä¸–ç•Œå¼€æ”¾è®¿é—®ï¼

### ðŸŒ è®¿é—®åœ°å€
- **ä¸»è¦åœ°å€**: https://chatbot.wilboerht.cn
- **å¤‡ç”¨åœ°å€**: http://120.55.160.247

### ðŸ”’ å®‰å…¨ç‰¹æ€§
- SSL/TLSåŠ å¯†ä¼ è¾“
- è‡ªåŠ¨HTTPSé‡å®šå‘
- å®‰å…¨å¤´é…ç½®
- é˜²ç«å¢™ä¿æŠ¤

### ðŸ“ˆ éƒ¨ç½²ç»Ÿè®¡
- **éƒ¨ç½²æ—¶é—´**: çº¦2å°æ—¶
- **ç³»ç»Ÿå…¼å®¹æ€§**: å®Œç¾Žé€‚é…é˜¿é‡Œäº‘Linux
- **Pythonç‰ˆæœ¬**: 3.6.8 (å…¼å®¹æ€§ä¼˜åŒ–)
- **SSLè¯ä¹¦**: Let's Encrypt (å…è´¹ï¼Œè‡ªåŠ¨ç»­æœŸ)
- **è®¿é—®æ€§èƒ½**: Nginxåå‘ä»£ç†ä¼˜åŒ–

**æ­å–œï¼ä½ çš„èŠå¤©æœºå™¨äººçŽ°åœ¨å·²ç»å¯ä»¥ä¸ºå…¨ä¸–ç•Œç”¨æˆ·æä¾›æœåŠ¡äº†ï¼** ðŸŽŠ
