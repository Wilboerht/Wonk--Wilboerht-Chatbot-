# Wonk Chatbot 服务器完整配置记录

## 📋 服务器信息
- **服务器IP**: 120.55.160.247
- **系统**: Alibaba Cloud Linux 3.2104 U12 (OpenAnolis Edition)
- **架构**: x86_64
- **Python版本**: 3.6.8
- **部署时间**: 2025-08-09/10

## 🚀 完整部署流程

### 第一步：连接服务器
```bash
ssh root@120.55.160.247
# 密码: @Whk35168
```

### 第二步：下载项目代码
```bash
cd /tmp
yum install -y git
git clone https://github.com/Wilboerht/Wonk--Wilboerht-Chatbot-.git
```

### 第三步：服务器环境配置
```bash
cd /tmp/Wonk--Wilboerht-Chatbot-/deploy

# 创建适配阿里云Linux的配置脚本
cat > server_setup_alinux.sh << 'EOF'
#!/bin/bash
set -e

# 颜色定义
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

log_info() { echo -e "${GREEN}[INFO]${NC} $1"; }
log_warn() { echo -e "${YELLOW}[WARN]${NC} $1"; }
log_error() { echo -e "${RED}[ERROR]${NC} $1"; }

# 更新系统
log_info "更新系统包..."
yum update -y

# 安装基础软件
log_info "安装基础软件包..."
yum install -y python3 python3-pip git nginx firewalld curl wget unzip htop tree

# 配置防火墙
log_info "配置防火墙..."
systemctl start firewalld
systemctl enable firewalld
firewall-cmd --permanent --add-service=ssh
firewall-cmd --permanent --add-service=http
firewall-cmd --permanent --add-service=https
firewall-cmd --permanent --add-port=5000/tcp
firewall-cmd --reload

# 创建应用用户
log_info "创建应用用户..."
if id "wonk" &>/dev/null; then
    log_warn "用户 wonk 已存在"
else
    useradd -m -s /bin/bash wonk
    log_info "用户 wonk 创建完成"
fi

# 创建应用目录
log_info "设置应用目录..."
mkdir -p /opt/wonk-chatbot
chown wonk:wonk /opt/wonk-chatbot

log_info "服务器基础环境配置完成！"
EOF

chmod +x server_setup_alinux.sh
./server_setup_alinux.sh
```

### 第四步：复制项目代码
```bash
cp -r /tmp/Wonk--Wilboerht-Chatbot-/* /opt/wonk-chatbot/
chown -R wonk:wonk /opt/wonk-chatbot
```

### 第五步：创建Python 3.6兼容的依赖文件
```bash
cd /opt/wonk-chatbot

cat > requirements_py36_compatible.txt << 'EOF'
# Flask Web框架 - Python 3.6兼容版本
Flask==2.0.3
Werkzeug==2.0.3
Jinja2==3.0.3
MarkupSafe==2.0.1
click==8.0.4
itsdangerous==2.0.1

# 基础依赖
python-dotenv==0.19.2
PyYAML==6.0
requests==2.27.1

# 数据处理 - 简化版本
pandas==1.1.5
openpyxl==3.0.10

# 文本处理
jieba==0.42.1

# 日志
loguru==0.5.3

# Pydantic - Python 3.6兼容版本
pydantic==1.9.2
EOF
```

### 第六步：安装Python依赖
```bash
# 创建虚拟环境
sudo -u wonk python3 -m venv venv

# 安装依赖（使用国内镜像源）
sudo -u wonk bash -c "
    source venv/bin/activate
    pip install -i https://pypi.tuna.tsinghua.edu.cn/simple/ -r requirements_py36_compatible.txt --timeout=60 --retries=3
"
```

### 第七步：创建systemd服务
```bash
cat > /etc/systemd/system/wonk-chatbot.service << 'EOF'
[Unit]
Description=Wonk Chatbot
After=network.target

[Service]
Type=simple
User=wonk
WorkingDirectory=/opt/wonk-chatbot
Environment=PATH=/opt/wonk-chatbot/venv/bin
Environment=FLASK_ENV=production
Environment=PYTHONUNBUFFERED=1
ExecStart=/opt/wonk-chatbot/venv/bin/python app.py
Restart=always
RestartSec=3

[Install]
WantedBy=multi-user.target
EOF

systemctl daemon-reload
systemctl enable wonk-chatbot
systemctl start wonk-chatbot
```

### 第八步：配置Nginx反向代理
```bash
cat > /etc/nginx/conf.d/wonk-chatbot.conf << 'EOF'
server {
    listen 80 default_server;
    server_name chatbot.wilboerht.cn 120.55.160.247 _;

    # 安全头
    add_header X-Frame-Options DENY;
    add_header X-Content-Type-Options nosniff;
    add_header X-XSS-Protection "1; mode=block";

    # 静态文件
    location /static/ {
        proxy_pass http://127.0.0.1:5000;
        expires 1y;
        add_header Cache-Control "public, immutable";
    }

    # 主应用
    location / {
        proxy_pass http://127.0.0.1:5000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # 超时设置
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
    }
}
EOF

nginx -t
systemctl restart nginx
systemctl enable nginx
```

### 第九步：配置SSL证书
```bash
# 安装certbot
yum install -y certbot python3-certbot-nginx

# 获取SSL证书
certbot --nginx -d chatbot.wilboerht.cn
# 邮箱: wilboerht@163.com
# 同意条款: Y
# 分享邮箱: N

# 设置自动续期
echo "0 12 * * * /usr/bin/certbot renew --quiet" | crontab -
```

## 🔧 最终配置状态

### 服务状态
```bash
# 应用服务
systemctl status wonk-chatbot

# Nginx服务
systemctl status nginx

# 防火墙状态
firewall-cmd --list-all
```

### 端口监听
```bash
ss -tlnp | grep -E "(80|443|5000)"
```

### 访问地址
- **HTTPS（推荐）**: https://chatbot.wilboerht.cn
- **HTTP**: http://chatbot.wilboerht.cn （自动重定向到HTTPS）
- **IP访问**: http://120.55.160.247
- **直接访问**: http://120.55.160.247:5000

### 重要文件位置
- **应用目录**: `/opt/wonk-chatbot/`
- **虚拟环境**: `/opt/wonk-chatbot/venv/`
- **数据库**: `/opt/wonk-chatbot/data/database.db`
- **systemd服务**: `/etc/systemd/system/wonk-chatbot.service`
- **Nginx配置**: `/etc/nginx/conf.d/wonk-chatbot.conf`
- **SSL证书**: `/etc/letsencrypt/live/chatbot.wilboerht.cn/`

### 日志查看
```bash
# 应用日志
journalctl -u wonk-chatbot -f

# Nginx访问日志
tail -f /var/log/nginx/access.log

# Nginx错误日志
tail -f /var/log/nginx/error.log

# SSL证书日志
tail -f /var/log/letsencrypt/letsencrypt.log
```

## 🛠️ 维护命令

### 服务管理
```bash
# 重启应用
systemctl restart wonk-chatbot

# 重启Nginx
systemctl restart nginx

# 查看服务状态
systemctl status wonk-chatbot nginx
```

### 证书管理
```bash
# 手动续期证书
certbot renew

# 查看证书状态
certbot certificates

# 查看自动续期任务
crontab -l
```

### 备份重要数据
```bash
# 备份数据库
cp /opt/wonk-chatbot/data/database.db /opt/wonk-chatbot/data/database_$(date +%Y%m%d_%H%M%S).db

# 备份配置文件
tar -czf /root/wonk-backup-$(date +%Y%m%d).tar.gz \
    /opt/wonk-chatbot/ \
    /etc/nginx/conf.d/wonk-chatbot.conf \
    /etc/systemd/system/wonk-chatbot.service
```

## ✅ 部署验证清单

- [x] 服务器连接正常
- [x] 项目代码下载完成
- [x] 系统环境配置完成
- [x] Python依赖安装成功
- [x] 应用服务启动正常
- [x] Nginx反向代理配置成功
- [x] 防火墙端口开放正确
- [x] SSL证书配置成功
- [x] HTTPS访问正常
- [x] HTTP自动重定向
- [x] 证书自动续期设置
- [x] 域名解析正常

## 🔒 安全配置

### 防火墙规则
```bash
# 当前开放端口
firewall-cmd --list-ports
# 输出: 5000/tcp

# 当前开放服务
firewall-cmd --list-services
# 输出: cockpit dhcpv6-client http https ssh
```

### SSL证书详情
```bash
# 证书文件位置
/etc/letsencrypt/live/chatbot.wilboerht.cn/fullchain.pem  # 证书链
/etc/letsencrypt/live/chatbot.wilboerht.cn/privkey.pem    # 私钥

# 证书有效期
# 颁发时间: 2025-08-10
# 到期时间: 2025-11-08
# 自动续期: 每天12:00检查
```

### Nginx最终配置
```nginx
# /etc/nginx/conf.d/wonk-chatbot.conf
server {
    server_name chatbot.wilboerht.cn 120.55.160.247 _;

    # 安全头
    add_header X-Frame-Options DENY;
    add_header X-Content-Type-Options nosniff;
    add_header X-XSS-Protection "1; mode=block";

    # 静态文件缓存
    location /static/ {
        proxy_pass http://127.0.0.1:5000;
        expires 1y;
        add_header Cache-Control "public, immutable";
    }

    # 主应用代理
    location / {
        proxy_pass http://127.0.0.1:5000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
    }

    # SSL配置 (由certbot自动添加)
    listen 443 ssl;
    ssl_certificate /etc/letsencrypt/live/chatbot.wilboerht.cn/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/chatbot.wilboerht.cn/privkey.pem;
    include /etc/letsencrypt/options-ssl-nginx.conf;
    ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem;
}

# HTTP重定向到HTTPS
server {
    if ($host = chatbot.wilboerht.cn) {
        return 301 https://$host$request_uri;
    }

    listen 80 default_server;
    server_name chatbot.wilboerht.cn 120.55.160.247 _;
    return 404;
}
```

## 📊 性能监控

### 系统资源使用
```bash
# 内存使用
free -h

# 磁盘使用
df -h

# CPU使用
htop

# 进程监控
ps aux | grep -E "(python|nginx)"
```

### 应用监控
```bash
# 应用进程状态
systemctl status wonk-chatbot

# 实时日志
journalctl -u wonk-chatbot -f

# 访问统计
tail -f /var/log/nginx/access.log | grep -E "(GET|POST)"
```

## 🚨 故障排除

### 常见问题及解决方案

#### 1. 应用无法启动
```bash
# 查看详细错误
journalctl -u wonk-chatbot -n 50

# 手动测试启动
sudo -u wonk bash -c "cd /opt/wonk-chatbot && source venv/bin/activate && python app.py"

# 检查依赖
sudo -u wonk bash -c "cd /opt/wonk-chatbot && source venv/bin/activate && pip list"
```

#### 2. SSL证书问题
```bash
# 检查证书状态
certbot certificates

# 手动续期
certbot renew --dry-run

# 重新获取证书
certbot --nginx -d chatbot.wilboerht.cn --force-renewal
```

#### 3. 域名解析问题
```bash
# 检查DNS解析
nslookup chatbot.wilboerht.cn
dig chatbot.wilboerht.cn

# 测试连通性
ping chatbot.wilboerht.cn
```

#### 4. 端口访问问题
```bash
# 检查端口监听
netstat -tlnp | grep -E "(80|443|5000)"
ss -tlnp | grep -E "(80|443|5000)"

# 检查防火墙
firewall-cmd --list-all
```

## 🔄 更新部署

### 更新应用代码
```bash
# 备份当前版本
cp -r /opt/wonk-chatbot /opt/wonk-chatbot-backup-$(date +%Y%m%d)

# 拉取最新代码
cd /tmp
rm -rf Wonk--Wilboerht-Chatbot-
git clone https://github.com/Wilboerht/Wonk--Wilboerht-Chatbot-.git

# 更新应用文件
cp -r /tmp/Wonk--Wilboerht-Chatbot-/* /opt/wonk-chatbot/
chown -R wonk:wonk /opt/wonk-chatbot

# 重启服务
systemctl restart wonk-chatbot
```

### 更新Python依赖
```bash
cd /opt/wonk-chatbot
sudo -u wonk bash -c "
    source venv/bin/activate
    pip install -r requirements_py36_compatible.txt --upgrade
"
systemctl restart wonk-chatbot
```

## 🎉 部署成功！

你的Wonk聊天机器人现已成功部署并对全世界开放访问！

### 🌐 访问地址
- **主要地址**: https://chatbot.wilboerht.cn
- **备用地址**: http://120.55.160.247

### 🔒 安全特性
- SSL/TLS加密传输
- 自动HTTPS重定向
- 安全头配置
- 防火墙保护

### 📈 部署统计
- **部署时间**: 约2小时
- **系统兼容性**: 完美适配阿里云Linux
- **Python版本**: 3.6.8 (兼容性优化)
- **SSL证书**: Let's Encrypt (免费，自动续期)
- **访问性能**: Nginx反向代理优化

**恭喜！你的聊天机器人现在已经可以为全世界用户提供服务了！** 🎊
